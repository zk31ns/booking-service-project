name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    name: Build and Push Docker image

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./src
          file: ./src/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Server
    needs: build_and_push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Clone/Update repository on server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          DEPLOY_PATH="/home/yc-user/booking_seats_team_project"
          GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          if [ -d "$DEPLOY_PATH" ]; then
            cd "$DEPLOY_PATH"
            git pull origin main
          else
            mkdir -p "$(dirname "$DEPLOY_PATH")"
            git clone https://${GITHUB_TOKEN}@github.com/Yandex-Practicum-Students/57_58_booking_seats_team_2.git "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"
          fi
          EOF

      - name: Start Docker containers
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            cd /home/yc-user/booking_seats_team_project/infra
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose pull
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose up -d
            sleep 10
          EOF

      - name: Run database migrations
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            cd /home/yc-user/booking_seats_team_project
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose -f infra/docker-compose.yml exec -T app alembic upgrade head
          EOF

      - name: Health check
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            for i in {1..30}; do
              if curl -s http://localhost:8000/docs > /dev/null; then
                echo "✅ Application is healthy!"
                exit 0
              fi
              echo "Waiting for application to be ready... ($i/30)"
              sleep 2
            done
            echo "❌ Application failed to start"
            exit 1
          EOF

      # - name: Notify Telegram (Success)
        # if: success()
        # uses: appleboy/telegram-action@master
        # with:
        #   to: ${{ secrets.TELEGRAM_CHAT_ID }}
        #   token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        #   message: |
        #     ✅ Production Deployment Successful!
        #     Repository: Booking Seats API
        #     Branch: main
        #     Commit: ${{ github.sha }}
        #     Server: ${{ secrets.DEPLOY_HOST }}

      # - name: Notify Telegram (Failure)
        # if: failure()
        # uses: appleboy/telegram-action@master
        # with:
        #   to: ${{ secrets.TELEGRAM_CHAT_ID }}
        #   token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        #   message: |
        #     ❌ Production Deployment Failed!
        #     Repository: Booking Seats API
        #     Branch: main
        #     Commit: ${{ github.sha }}
        #     Error: Check GitHub Actions logs for details
        #     Server: ${{ secrets.DEPLOY_HOST }}
