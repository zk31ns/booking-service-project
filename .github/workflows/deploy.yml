name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    name: Build and Push Docker image

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./src
          file: ./src/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Server
    needs: build_and_push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Clone/Update repository on server
        run: |
          DEPLOY_PATH="/home/yc-user/booking_seats_team_project"
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "mkdir -p $DEPLOY_PATH"
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '.env' \
            --exclude 'infra/pgdata' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:$DEPLOY_PATH/

      - name: Start Docker containers
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            cd /home/yc-user/booking_seats_team_project/infra

            # Stop and remove old containers
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose down || true

            # Pull latest images
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose pull

            # Start containers
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose up -d

            echo "Waiting for containers to be running..."

            # Wait for app container to be running (max 5 minutes)
            CONTAINER_NAME="booking_app"
            MAX_WAIT=300
            ELAPSED=0

            while [ $ELAPSED -lt $MAX_WAIT ]; do
              STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_NAME" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "running" ]; then
                echo "✅ Container $CONTAINER_NAME is running!"
                break
              elif [ "$STATUS" = "restarting" ]; then
                echo "⏳ Container $CONTAINER_NAME is restarting... (${ELAPSED}s elapsed)"
              elif [ "$STATUS" = "not_found" ]; then
                echo "❌ Container $CONTAINER_NAME not found!"
                exit 1
              else
                echo "⏳ Container $CONTAINER_NAME status: $STATUS (${ELAPSED}s elapsed)"
              fi

              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done

            if [ $ELAPSED -ge $MAX_WAIT ]; then
              echo "❌ Timeout waiting for container $CONTAINER_NAME to be running!"
              echo "Container logs:"
              docker logs --tail 50 "$CONTAINER_NAME" 2>/dev/null || true
              exit 1
            fi

            echo "Container status:"
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose ps
            echo "App container logs (last 30 lines):"
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose logs --tail 30 app || true
          EOF

      - name: Run database migrations
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            cd /home/yc-user/booking_seats_team_project/infra

            # Ensure container is stable and running before executing migrations
            CONTAINER_NAME="booking_app"
            MAX_WAIT=300
            ELAPSED=0
            STABLE_COUNT=0
            REQUIRED_STABLE_CHECKS=3

            echo "Waiting for container to be stable and running..."
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_NAME" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "running" ]; then
                STABLE_COUNT=$((STABLE_COUNT + 1))
                echo "✅ Container is running (stable check: ${STABLE_COUNT}/${REQUIRED_STABLE_CHECKS})"

                if [ $STABLE_COUNT -ge $REQUIRED_STABLE_CHECKS ]; then
                  echo "✅ Container is stable, proceeding with migrations..."
                  break
                fi
              elif [ "$STATUS" = "restarting" ]; then
                STABLE_COUNT=0
                echo "⏳ Container is restarting, resetting stability check... (${ELAPSED}s elapsed)"
              else
                STABLE_COUNT=0
                echo "⏳ Container status: $STATUS (${ELAPSED}s elapsed)"
              fi

              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done

            if [ $STABLE_COUNT -lt $REQUIRED_STABLE_CHECKS ]; then
              echo "❌ Container did not become stable! Status: $STATUS"
              echo "Container logs:"
              docker logs --tail 100 "$CONTAINER_NAME" 2>/dev/null || true
              echo "Container inspect:"
              docker inspect "$CONTAINER_NAME" 2>/dev/null | grep -A 20 "State" || true
              exit 1
            fi

            # Final check right before executing command
            echo "Final check before running migrations..."
            for i in {1..5}; do
              FINAL_STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_NAME" 2>/dev/null || echo "not_found")
              if [ "$FINAL_STATUS" != "running" ]; then
                echo "⚠️ Container status changed to: $FINAL_STATUS, waiting..."
                sleep 3
              else
                echo "✅ Container confirmed running, executing migrations..."
                break
              fi

              if [ $i -eq 5 ]; then
                echo "❌ Container not stable for final check!"
                exit 1
              fi
            done

            # Run migrations with retry logic
            echo "Running database migrations..."
            MAX_RETRIES=3
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              # Check status one more time before exec
              CURRENT_STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_NAME" 2>/dev/null || echo "not_found")
              if [ "$CURRENT_STATUS" != "running" ]; then
                echo "⚠️ Container status is $CURRENT_STATUS, waiting 5 seconds..."
                sleep 5
                RETRY_COUNT=$((RETRY_COUNT + 1))
                continue
              fi

              if IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose exec -T app alembic upgrade head 2>&1; then
                echo "✅ Migrations completed successfully!"
                exit 0
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "❌ Migrations failed (attempt ${RETRY_COUNT}/${MAX_RETRIES}), checking container status..."
                  docker inspect -f '{{.State.Status}}' "$CONTAINER_NAME" || true
                  docker logs --tail 20 "$CONTAINER_NAME" 2>/dev/null || true
                  echo "Waiting 10 seconds before retry..."
                  sleep 10
                fi
              fi
            done

            echo "❌ Migrations failed after ${MAX_RETRIES} attempts"
            exit 1
          EOF

      - name: Health check
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            for i in {1..30}; do
              if curl -s http://localhost:8000/docs > /dev/null; then
                echo "✅ Application is healthy!"
                exit 0
              fi
              echo "Waiting for application to be ready... ($i/30)"
              sleep 2
            done
            echo "❌ Application failed to start"
            exit 1
          EOF

      # - name: Notify Telegram (Success)
        # if: success()
        # uses: appleboy/telegram-action@master
        # with:
        #   to: ${{ secrets.TELEGRAM_CHAT_ID }}
        #   token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        #   message: |
        #     ✅ Production Deployment Successful!
        #     Repository: Booking Seats API
        #     Branch: main
        #     Commit: ${{ github.sha }}
        #     Server: ${{ secrets.DEPLOY_HOST }}

      # - name: Notify Telegram (Failure)
        # if: failure()
        # uses: appleboy/telegram-action@master
        # with:
        #   to: ${{ secrets.TELEGRAM_CHAT_ID }}
        #   token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        #   message: |
        #     ❌ Production Deployment Failed!
        #     Repository: Booking Seats API
        #     Branch: main
        #     Commit: ${{ github.sha }}
        #     Error: Check GitHub Actions logs for details
        #     Server: ${{ secrets.DEPLOY_HOST }}
