name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    name: Build and Push Docker image

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./src
          file: ./src/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Server
    needs: build_and_push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Clone/Update repository on server
        run: |
          DEPLOY_PATH="/home/yc-user/booking_seats_team_project"
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "mkdir -p $DEPLOY_PATH"
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '.env' \
            --exclude 'infra/pgdata' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:$DEPLOY_PATH/

      - name: Start Docker containers
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            cd /home/yc-user/booking_seats_team_project/infra

            # Stop and remove old containers
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose down || true

            # Pull latest images
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose pull

            # Start containers
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose up -d

            echo "Waiting for containers to be running..."

            # Wait for app container to be running (max 5 minutes)
            CONTAINER_NAME="booking_app"
            MAX_WAIT=300
            ELAPSED=0

            while [ $ELAPSED -lt $MAX_WAIT ]; do
              STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_NAME" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "running" ]; then
                echo "✅ Container $CONTAINER_NAME is running!"
                break
              elif [ "$STATUS" = "restarting" ]; then
                echo "⏳ Container $CONTAINER_NAME is restarting... (${ELAPSED}s elapsed)"
              elif [ "$STATUS" = "not_found" ]; then
                echo "❌ Container $CONTAINER_NAME not found!"
                exit 1
              else
                echo "⏳ Container $CONTAINER_NAME status: $STATUS (${ELAPSED}s elapsed)"
              fi

              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done

            if [ $ELAPSED -ge $MAX_WAIT ]; then
              echo "❌ Timeout waiting for container $CONTAINER_NAME to be running!"
              echo "Container logs:"
              docker logs --tail 50 "$CONTAINER_NAME" 2>/dev/null || true
              exit 1
            fi

            echo "Container status:"
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose ps
            echo "App container logs (last 30 lines):"
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose logs --tail 30 app || true
          EOF

      - name: Run database migrations
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            cd /home/yc-user/booking_seats_team_project/infra

            # Ensure container is running before executing migrations
            CONTAINER_NAME="booking_app"
            MAX_WAIT=120
            ELAPSED=0

            echo "Checking container status before running migrations..."
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_NAME" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "running" ]; then
                echo "✅ Container is running, proceeding with migrations..."
                break
              elif [ "$STATUS" = "restarting" ]; then
                echo "⏳ Container is restarting, waiting... (${ELAPSED}s elapsed)"
              else
                echo "⏳ Container status: $STATUS (${ELAPSED}s elapsed)"
              fi

              sleep 3
              ELAPSED=$((ELAPSED + 3))
            done

            if [ "$STATUS" != "running" ]; then
              echo "❌ Container is not running! Status: $STATUS"
              echo "Container logs:"
              docker logs --tail 50 "$CONTAINER_NAME" 2>/dev/null || true
              exit 1
            fi

            # Wait a bit more for the app to be fully ready
            echo "Waiting 10 seconds for application to be fully ready..."
            sleep 10

            # Run migrations
            echo "Running database migrations..."
            IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose exec -T app alembic upgrade head || {
              echo "❌ Migrations failed! Retrying in 5 seconds..."
              sleep 5
              IMAGE_TAG=${{ github.sha }} DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/booking-seats-api docker-compose exec -T app alembic upgrade head
            }
            echo "✅ Migrations completed successfully!"
          EOF

      - name: Health check
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            for i in {1..30}; do
              if curl -s http://localhost:8000/docs > /dev/null; then
                echo "✅ Application is healthy!"
                exit 0
              fi
              echo "Waiting for application to be ready... ($i/30)"
              sleep 2
            done
            echo "❌ Application failed to start"
            exit 1
          EOF

      # - name: Notify Telegram (Success)
        # if: success()
        # uses: appleboy/telegram-action@master
        # with:
        #   to: ${{ secrets.TELEGRAM_CHAT_ID }}
        #   token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        #   message: |
        #     ✅ Production Deployment Successful!
        #     Repository: Booking Seats API
        #     Branch: main
        #     Commit: ${{ github.sha }}
        #     Server: ${{ secrets.DEPLOY_HOST }}

      # - name: Notify Telegram (Failure)
        # if: failure()
        # uses: appleboy/telegram-action@master
        # with:
        #   to: ${{ secrets.TELEGRAM_CHAT_ID }}
        #   token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        #   message: |
        #     ❌ Production Deployment Failed!
        #     Repository: Booking Seats API
        #     Branch: main
        #     Commit: ${{ github.sha }}
        #     Error: Check GitHub Actions logs for details
        #     Server: ${{ secrets.DEPLOY_HOST }}
